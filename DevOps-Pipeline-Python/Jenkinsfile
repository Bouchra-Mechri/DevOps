pipeline {
    agent any
    environment {
        rcred = 'dockerhub'
        rname = 'survey-app-img'
    }
    

    stages {
         stage('Checkout'){
            agent any
            steps{
                checkout scm
            }
        }
        stage('build') {
            steps {
             script {
    withCredentials([usernamePassword(credentialsId: rcred, usernameVariable: 'ACR_USER', passwordVariable: 'ACR_PASSWORD')]) {
        sh "docker login --username ${ACR_USER} --password ${ACR_PASSWORD}"
        sh "docker build -t bouchra445/survey-app-img:$BUILD_ID DevOps-Pipeline-Python/Python"
        sh "docker tag bouchra445/survey-app-img:$BUILD_ID bouchra445/survey-app-img:$BUILD_ID"
        sh "docker push bouchra445/survey-app-img:$BUILD_ID"
               
    }
}

            }
        }
        stage('gitops'){
            steps{
                script{
                     sh "sed -i 's|image: bouchra445/survey-app-img|image: bouchra445/survey-app-img:$BUILD_ID|' DevOps-Pipeline-Python/k8s/deployment.yaml"
        
        // Commit the changes to the git repository
        sh "git config --global user.email 'mechrib466@gmail.com'"
        sh "git config --global user.name 'Bouchra-Mechri'"
        sh "git add DevOps-Pipeline-Python/k8s/deployment.yaml"
        sh "git commit -m 'Update image tag to $BUILD_ID'"
        sh "git push origin main"  // Replace 'main' with your branch name
                }
            }
        }
        stage('logout'){
            agent any
            steps {
                sh 'docker logout'
            }
        }
    }
}
